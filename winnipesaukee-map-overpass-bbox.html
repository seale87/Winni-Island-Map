<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Lake Winnipesaukee Islands Map (Overpass BBOX)</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
  <style>
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial}
    .wrap{display:grid;grid-template-columns:340px 1fr;gap:12px;padding:12px}
    @media (max-width: 900px){.wrap{grid-template-columns:1fr;}}
    .panel{border:1px solid #e5e7eb;border-radius:12px;padding:12px;background:#fff;max-height:calc(100vh - 24px);overflow:auto}
    .controls{display:grid;gap:8px;margin-bottom:8px}
    .search{width:100%;padding:8px 10px;border:1px solid #d1d5db;border-radius:10px}
    .filters summary{cursor:pointer;margin:6px 0;font-weight:600}
    .filter-grid{display:grid;gap:8px;margin:8px 0}
    .reset{margin-top:8px;border:1px solid #d1d5db;background:#f9fafb;border-radius:8px;padding:6px 10px;cursor:pointer}
    .stats{font-size:.9rem;color:#4b5563;margin:6px 0}
    .list{list-style:none;padding:0;margin:0;display:grid;gap:6px}
    .item{border:1px solid #e5e7eb;border-radius:10px;padding:8px}
    .item h4{margin:0 0 4px 0;font-size:1rem}
    .item .meta{font-size:.85rem;color:#6b7280}
    #map{border:1px solid #e5e7eb;border-radius:12px;min-height:70vh}
    .leaflet-popup-content img{max-width:220px;height:auto;border-radius:8px;display:block;margin:6px 0}
    .note{font-size:.85rem;color:#6b7280;margin-top:6px}
    .log{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size:.8rem; color:#6b7280}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="panel">
      <div class="controls">
        <input id="search" class="search" type="search" placeholder="Search islands…"/>
        <details class="filters">
          <summary>Filters</summary>
          <div class="filter-grid">
            <label><input type="checkbox" data-filter="public_access" value="true"> Public access</label>
            <label><input type="checkbox" data-filter="has_bridge" value="true"> Has bridge/causeway</label>
            <label style="display:grid;gap:4px">
              <span>Town</span>
              <select id="town" multiple size="5"></select>
            </label>
            <label style="display:grid;gap:4px">
              <span>Size (acres)</span>
              <select id="size">
                <option value="">All</option>
                <option value="xs">Under 5</option>
                <option value="s">5–25</option>
                <option value="m">25–100</option>
                <option value="l">100–300</option>
                <option value="xl">300+</option>
              </select>
            </label>
          </div>
          <button class="reset" type="button">Reset filters</button>
        </details>
        <div class="stats">
          <span id="vis">0</span> of <span id="tot">0</span> islands shown
          <button id="dl" style="margin-left:8px;border:1px solid #d1d5db;background:#f9fafb;border-radius:8px;padding:6px 10px;cursor:pointer">Download JSON</button>
        </div>
        <div class="note">This version queries Overpass using a bounding box (more reliable on GitHub Pages). If you add <code>?data=URL</code> it will use your own JSON instead.</div>
        <div class="log" id="log"></div>
      </div>
      <ul class="list" id="list" aria-live="polite"></ul>
    </div>
    <div id="map"></div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script>
    const qs = new URLSearchParams(location.search);
    const DATA_URL = qs.get('data') || ''; // optional override

    const log = (...args)=>{ const el=document.getElementById('log'); el.textContent += args.join(' ') + '\\n'; };

    // Map
    const map = L.map('map').setView([43.616, -71.316], 11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19, attribution:'&copy; OpenStreetMap contributors'}).addTo(map);
    const bounds = L.latLngBounds([43.50, -71.50], [43.80, -71.15]);
    map.setMaxBounds(bounds);
    map.on('drag', () => map.panInsideBounds(bounds, {animate:false}));

    const cluster = L.markerClusterGroup({ showCoverageOnHover:false, maxClusterRadius:50 });
    let ALL = [], FILTERED = [];

    const elList = document.getElementById('list');
    const elVis = document.getElementById('vis');
    const elTot = document.getElementById('tot');
    const elSearch = document.getElementById('search');
    const elTown = document.getElementById('town');
    const elSize = document.getElementById('size');
    const elReset = document.querySelector('.reset');

    function debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms);} }
    function bucket(ac){ if(ac==null) return ''; if(ac<5) return 'xs'; if(ac<25) return 's'; if(ac<100) return 'm'; if(ac<300) return 'l'; return 'xl'; }
    function normalize(f){
      return { name:f.name||'', lat:+f.lat, lng:+f.lng, town:f.town||'', size_acres:(f.size_acres!=null?+f.size_acres:null),
        public_access:!!f.public_access, has_bridge:!!f.has_bridge, notes:f.notes||'', image:f.image||'', link:f.link||'' };
    }

    function popupHTML(f){
      return `<h3 style="margin:0 0 6px 0;">${f.name}</h3>
        ${f.town?`<div><strong>Town:</strong> ${f.town}</div>`:''}
        ${f.size_acres!=null?`<div><strong>Size:</strong> ${f.size_acres} acres</div>`:''}`;
    }

    function renderMarkers(arr){
      cluster.clearLayers();
      const markers = arr.filter(f=>Number.isFinite(f.lat)&&Number.isFinite(f.lng)).map(f=>{
        const m=L.marker([f.lat,f.lng],{title:f.name}); m.bindPopup(popupHTML(f)); return m;
      });
      cluster.addLayers(markers); map.addLayer(cluster);
      if(markers.length){ try{ map.fitBounds(cluster.getBounds(), {padding:[30,30]}); }catch(e){} }
    }

    function renderList(arr){
      elList.innerHTML='';
      arr.forEach(f=>{
        const li=document.createElement('li');
        li.className='item';
        li.innerHTML=`<h4>${f.name}</h4>`;
        li.onclick=()=>{
          const tgt=cluster.getLayers().find(m=>m.getLatLng().lat===f.lat && m.getLatLng().lng===f.lng);
          if(tgt){ map.setView(tgt.getLatLng(), Math.max(map.getZoom(), 13)); tgt.openPopup(); }
        };
        elList.appendChild(li);
      });
      elVis.textContent=String(arr.length);
      elTot.textContent=String(ALL.length);
    }

    function hydrateTowns(arr){
      const set=[...new Set(arr.map(f=>f.town).filter(Boolean))].sort((a,b)=>a.localeCompare(b));
      elTown.innerHTML='';
      set.forEach(t=>{ const o=document.createElement('option'); o.value=t; o.textContent=t; elTown.appendChild(o); });
    }

    function passFilters(f){
      const q=(elSearch.value||'').trim().toLowerCase();
      if(q && !(f.name||'').toLowerCase().includes(q)) return false;
      if(elSize.value && bucket(f.size_acres)!==elSize.value) return false;
      return true;
    }

    function applyFilters(){
      FILTERED = ALL.filter(passFilters);
      renderMarkers(FILTERED);
      renderList(FILTERED);
    }

    function wire(){
      elSearch.addEventListener('input', debounce(applyFilters,120));
      elTown.addEventListener('change', applyFilters);
      elSize.addEventListener('change', applyFilters);
      elReset.onclick=()=>{ elSearch.value=''; [...elTown.options].forEach(o=>o.selected=false); elSize.value=''; applyFilters(); };
      document.getElementById('dl').onclick = () => {
        const blob = new Blob([JSON.stringify(ALL, null, 2)], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'winnipesaukee_islands.json'; a.click();
        setTimeout(()=>URL.revokeObjectURL(url), 3000);
      };
    }

    async function fetchOverpassBbox(){
      // Bounding box around Lake Winnipesaukee
      const s=43.50, w=-71.50, n=43.80, e=-71.15;
      const query = `[out:json][timeout:25];
        (
          node["place"~"islet|island"](${s},${w},${n},${e});
          way["place"~"islet|island"](${s},${w},${n},${e});
          relation["place"~"islet|island"](${s},${w},${n},${e});
        );
        out center tags;`;

      const endpoints = [
        'https://overpass-api.de/api/interpreter',
        'https://overpass.kumi.systems/api/interpreter',
        'https://maps.mail.ru/osm/tools/overpass/api/interpreter'
      ];

      for(const base of endpoints){
        try {
          log('Querying:', base);
          const url = base + '?data=' + encodeURIComponent(query);
          const res = await fetch(url, { method:'GET' });
          if(!res.ok) { log('HTTP', res.status); continue; }
          const json = await res.json();
          log('Got', (json.elements||[]).length, 'elements');
          if((json.elements||[]).length){
            return (json.elements||[])
              .map(e=>{
                const name = e.tags && (e.tags.name || e.tags["alt_name"] || e.tags["old_name"]);
                const lat = e.type==='node' ? e.lat : (e.center && e.center.lat);
                const lon = e.type==='node' ? e.lon : (e.center && e.center.lon);
                return name && lat && lon ? {name:name, lat:lat, lng:lon} : null;
              })
              .filter(Boolean);
          }
        } catch(err) {
          log('Error:', (err&&err.message)||String(err));
        }
      }
      throw new Error('All Overpass endpoints failed');
    }

    async function load(){
      try{
        if(DATA_URL){
          log('Loading provided JSON:', DATA_URL);
          const r = await fetch(DATA_URL, {cache:'no-store'});
          if(!r.ok) throw 0;
          const js = await r.json();
          ALL = (js||[]).map(normalize);
        } else {
          const feats = await fetchOverpassBbox();
          // Deduplicate by name+rounded coords
          const seen = new Set(); const unique=[];
          for(const f of feats){
            const k = f.name + '|' + f.lat.toFixed(5) + '|' + f.lng.toFixed(5);
            if(!seen.has(k)){ seen.add(k); unique.push(f); }
          }
          ALL = unique.map(normalize);
        }
      } catch(e){
        log('Falling back to 5-sample list.');
        ALL = [
          {name:"Bear Island",lat:43.6276,lng:-71.3619},
          {name:"Rattlesnake Island",lat:43.5957,lng:-71.2881},
          {name:"Governors Island",lat:43.60972,lng:-71.42528},
          {name:"Cow Island",lat:43.6538,lng:-71.3859},
          {name:"Long Island",lat:43.694,lng:-71.366}
        ].map(normalize);
      }
      after();
    }

    function after(){
      hydrateTowns(ALL);
      FILTERED=ALL.slice();
      renderMarkers(FILTERED);
      renderList(FILTERED);
      wire();
    }

    load();
  </script>
</body>
</html>